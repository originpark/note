##### Internet

网络包括**结点**和连接各个结点的**链路**

在计算机网络中：

结点分为**主机结点**（数据源，数据目标）和**交换结点**（路由器，交换机）

链路分为**接入链路**（主机结点与交换结点之间的连接）和**骨干链路**（交换结点和交换结点之间的连接）

多个计算机网络的互联就称为互联网

不同的互联网遵顼不同的协议，最大的互联网叫**Internet**因特网

互联网中，各个主机称为**edge**边缘，接入链路称为**access**，由交换结点和骨干链路组成的部分称为**core**核心



c/s模式，客户端将请求发送给服务器，服务器接收并处理请求

peer to peer模式：每个主机既充当客户端，也可以充当服务器





分组交换：

- 先存储后转发是为了链路的共享
- 当某个分组存储完成以后，如果下一个目标链路上有其他分组正在转发，那么就需要排队等候，并且分组交换机的队列大小是有限的，如果有分组发送过来但是该交换机的队列已经满了，那么该分组就会被丢弃





上层传递过来的数据叫做SDU ，SDU传递给本层，添加上本层的数据后形成了PDU



##### 应用层

- socket是位于本地主机的一个标识，其内保存了数据传输双方的ip和端口信息，使得发送数据时无需再加上对方主机的ip和端口信息，便于通信双方之间的数据传输

- 缓存：client发送请求后，进入缓存服/代理服务器（proxy），先检查缓存服务器中有没有请求需要的数据，有就直接响应该缓存，没有就将请求发送给original server原始服务器，从原始服务器获取到响应后，先保存再缓存中，然后发送给客户端

- 应用层协议：

  - http request, response, cookie, session

  - FTP 文件传输协议

  - EMail 用户通过邮件服务器发送和接收邮件

  - DNS (Domain Name System)提供从域名到ip地址的转换，采用分层命名以及分布式数据库（将解析工作交给多个服务器来完成）来解析域名，这些分布式的服务器叫做区域名字服务器，区域名字服务器维护资源记录，资源记录维护了域名到ip地址的映射关系

    每个资源记录可看成数据库中的一条数据，包含以下字段

    - Class 资源记录的类别，对于Interent来说是IN
    - TTL (time to leave)生存时间，如果是有限值，则可以看成缓存
    - domain_name 域名
    - value ip地址
    - Type  用以标识该资源记录的作用

- p2p 

  - 集中式目录：客户端发起请求给目录服务器，目录服务器在索引找到拥有请求资源的目标主机的地址，将该地址发送给请求方，请求方再对该主机发起请求
  - 完全分布式：客户端向自己的邻居发送请求，每个邻居再分别向他们的邻居发送请求，直到寻找到有资源的主机，该主机回传信息，然后客户端向这些有资源的主机发起请求
  - 混合式：将结点组合为多个组，每个组有组长和组员，组员发请求时先发给组长，组长检查组内是否有该资源，如果有，则直接让请求方请求该有资源的主机，如果没有，组长就将请求发送给其他组长，从其他组处获取资源
  - 每个文件除了文件本身数据外，还包含一个hash值和描述，hash用于唯一标识该文件，描述用户用户的搜索，客户端在请求文件的时候，是发送一个带有目标文件hash值的http请求

- CDN 例如将视频文件分成多个小部分，每个小部分存储在不同的cdn服务器中，用户请求时向就近的cdn服务器请求数据





##### 传输层

- 传输层解决进程到进程间的通信，有发送方和接收方，并且有一系列使通信可靠的措施，并且有以下演化过程
  1. 发送方发送数据分组p1，接收方如果成功接收数据，那么就回送一个ACK1代表确认，发送方收到ACK后继续发送下一分组p2，如果接收方没有成功收到，则回送一个NAK表示没有成功接收，发送方收到NAK，则重新发送p1
  2. 1中会出现一个问题，即如果回送的ACK或NAK也出错了怎么办？因此，当发送方发送p1，收到出错的回送数据时，会将p1再发送一次，这种情况下接收方就有可能会收到两份p1，因此给分组加入序号机制，如果接收方收到了序号相同的分组，就将多余的分组丢弃
  3. 在上述基础上，取消对NAK的使用，即不需要发送NAK，此时如果接收方接收p2出错的话，回送的数据为ACK1，即回送上一个分组的ACK，这样也能表示p2发送失败
  4. 新的问题：如果发送方一直收不到ACK怎么办，因此加入超时重传机制
  5. 上述机制叫做rdt，可以运行，但是由于是一个一个地发送，效率很低，因此考虑使用流水线形式，一次发送多个分组，在发送方和接收方使用滑动窗口机制来实现这一功能，接收方窗口大小为1时，为顺序接收，窗口大小大于1时，为乱序接收
- TCP 面向连接的传输
  - TCP传输的是字节流，将这些字节流拆分成一个个mss，每个mss都包含TCP头部和body部分，body部分的第一个字节表示该mss的序号，该字节在整个字节流中的偏移量为这个mss的序号的值，第一个mss的序号不是0，是要规定的
  - 发送发收到了ack=5说明接收方已经收到前四个mss
  - TCP连接管理
    - 连接建立为什么不能是两次握手？（发起连接请求，确认连接），因为存在超时重传的机制，如果第一次发起连接请求后，接收数据超时，就会重新发送一次连接请求，这时第一次的连接请求的回应数据回来了，成功建立连接，但是对于接收发来说，它收到了两次连接请求，因此就会形成一个半连接，会导致很多问题
    - 三次握手表示，第一次客户端请求连接并发送客户端mss的序号，服务端回送ACK并发送服务端mss的序号，然后客户端将ACK和数据一起发送，连接建立成功
    - 连接释放：分为两部分，一是客户端向服务端发送连接拆除请求，服务端回送确认，此时客户端指向服务端的数据通道拆除；二是服务端向客户端发送连接拆除请求，客户端回送确认，此时服务端指向客户端的数据通道拆除
- 拥塞控制 拥塞的表现为分组丢失（路由器缓冲区溢出）和分组经历比较长的延迟，例如超时重传导致的输入数据远远大于有效输出数据
  - TCP拥塞控制
    - 拥塞检测
      - 分组丢失/超时 拥塞
      - 冗余ACK 轻微拥塞
    - 速率控制 date = congWin / RTT ，这个date就是拥塞控制机制给发送方限制的发送速率，congWin代表接收方滑动窗口中的空闲位置大小
      - 拥塞窗口的值，先呈指数级增加，1， 2，4...， 例如在16时发生拥塞，则标记16的一半8，再次从1开始指数增加，这个阶段叫慢启动阶段，当增加到8的时候，开始线性增加，即9，10，11，如果是轻微拥塞，则直接降到一般，然后线性增加





##### 网络层

网络层分为控制平面和数据平面，控制平面决定分组在宏观上的路径，数据平面保证分组从某节点传输到另一节点



**IP协议**

- 网络链路有最大传输单元MTU，即链路层的帧所携带的最大数据长度，因此不同的链路的MTU不同，较大的数据无法一次性传输给MTU较小的链路，因此需要对传输的数据进行分片和重组
  - 分片：将一个大的数据报变成若干个小的数据报，每一片都有头部和数据部分，头部中包含了ID字段，同一数据报的多个分片拥有相同的ID；头部中的offset字段用以区分同一ID的数据报的先后顺序，flag字段有1和0两个标记，1代表该切分后面还有切片，0代表这是最后一个切片
  - 重组：由目标主机来重组
  - 如果有某个切片没到，那么就把相同ID的切片都丢弃
- IP地址：ip地址是对主机或者路由器与网络的接口的标识，因此路由器的IP地址有两个及两个以上
  - 子网
    - ip地址的前缀相同
    - 数据传输不需要依靠路由器，子网内各主机在物理上可以相互直达，当然多个子网构成的网络对外界来说也是一个子网，这时该子网内会有路由器
  - 127开头的ip叫做回路地址/测试地址，即当数据到达网络层后会原路返回，等于传给自己
  - 内网IP地址：ABCD类的ip地址中都各有一部分地址是专门用来当作内网地址的，不能用于公网，内网地址的作用是区分同一子网内的主机，路由器不会转发内网ip，例如A类地址中的10.0.0.0-10.255.255.255这个范围内的地址都是内网地址
  - 子网掩码：ipv4的子网掩码同ipv4地址一样是32bit，每个比特的0和1表示的是该位是网络号还是主机号，例如，对于A类地址来说，其第一字节表示网络号，那么A类地址的子网掩码的第一个字节的所有bit就都是1，后面三个字节都是主机号，因此都是0，所以A类地址的子网掩码就是255.0.0.0，原ip地址与子网掩码进行按位得到的结果就是主机号全为0的ip地址，即可以看作网络号。
  - CIDR 无类域间路由，即不区分ip地址的类别，可以在32个bit中任意切一刀，左边表示网络号，右边表示主机号
  - 地址转换，内网地址在向外网请求数据时要经过地址转换，外网数据传回来时再将该转换后的地址转换回内网地址
- IPV6 
  - 数据报在路由器中不进行分片，而是通过路由器回传的信息让原主机进行分片



**控制平面**

将全世界的路由器划分为不同的自治区，每个自治区可以选择自己的路由选择算法，这样从自治区的角度来看，自治区的数量就很有限了，这样就能很好地使用路由选择算法

相邻两个自治区之间通过网关相互通信，网关间维护了一个tcp的连接







##### 链路层

- 链路层的连接方式分为点到点和多点连接，广域网采用点到点，局域网采用多点连接（交换机）
- MAC地址解决同一个网络中不同主机的编址问题，由IP地址解析为MAC地址的协议叫做ARP

